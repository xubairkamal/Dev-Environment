{% extends base_template %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'core_app/css/dataTables.bootstrap5.min.css' %}">

<style>
    /* Grid Styling */
    .dataTables_wrapper .dataTables_paginate .paginate_button {
        padding: 0;
        margin-left: 2px;
    }

    .dataTables_filter input {
        border-radius: 20px;
        padding: 5px 15px;
        border: 1px solid #dee2e6;
        outline: none;
    }

    .card-body.p-0 .dataTables_wrapper {
        padding: 1.25rem;
    }

    .table th,
    .table td {
        vertical-align: middle;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.05);
        transition: background-color 0.2s ease;
    }

    .text-amount {
        font-family: 'Courier New', Courier, monospace;
        font-weight: bold;
    }
</style>

<div class="container-fluid mt-2">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h3 class="fw-bold mb-0"><i class="bi bi-cash-stack text-success"></i> Cash Book</h3>
            <p class="text-muted small mb-0">Track and manage financial transactions.</p>
        </div>
        <div class="d-flex gap-2">
            <div class="input-group input-group-sm shadow-sm">
                <span class="input-group-text bg-white border-end-0"><i class="bi bi-calendar3"></i></span>
                <input type="date" id="filter_from_date" class="form-control border-start-0" value="{{ from_date }}">
                <input type="date" id="filter_to_date" class="form-control" value="{{ to_date }}">
                <button type="button" class="btn btn-primary" onclick="reloadCashTable()"><i
                        class="bi bi-search"></i></button>
            </div>
            <button class="btn btn-success shadow-sm d-flex align-items-center gap-2" onclick="openAddCashModal()">
                <i class="bi bi-plus-lg"></i> <span>Add Entry</span>
            </button>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body p-0" id="cashGridContainer">
            <div class="table-responsive">
                <table id="cashGrid" class="table table-hover align-middle mb-0 w-100">
                    <thead class="bg-light text-secondary">
                        <tr>
                            <th class="ps-4" style="width: 140px;">Date</th>
                            <th>Voucher #</th>
                            <th>Account Name</th>
                            <th>Description</th>
                            <th class="text-end">Amount</th>
                            <th class="text-center pe-4" style="width: 150px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="cashTableBody">
                        {% for row in transactions %}
                        <tr>
                            <td class="ps-4 text-dark fw-semibold">{{ row.dttrdate|date:"d-M-Y"|default:row.dttrdate }}
                            </td>

                            <td><span class="badge bg-light text-dark border">{{ row.vctrnmbr }}</span></td>

                            <td>
                                <div class="fw-bold text-primary">{{ row.vcacname }}</div>
                                <small class="text-muted">{{ row.vcvtacrn }}</small>
                            </td>

                            <td class="small text-muted">{{ row.vctrdesc|default:"-" }}</td>

                            <td class="text-end text-amount pe-3">
                                <span class="text-dark">{{ row.mntramnt }}</span>
                            </td>

                            <td class="text-center pe-4">
                                <div class="btn-group shadow-sm">
                                    <button class="btn btn-sm btn-white border" title="Edit Entry"
                                        onclick="openEditCashModal('{{ row.intrcode }}', '{{ row.inaccode }}', '{{ row.vcacname }}', '{{ row.mntramnt }}', '{{ row.vctrdesc }}', '{{ row.intrvrsn }}')">
                                        <i class="bi bi-pencil-square text-primary"></i>
                                    </button>
                                    <button class="btn btn-sm btn-white border" title="Delete Entry"
                                        onclick="openDeleteCashModal('{{ row.intrcode }}', '{{ row.intrvrsn }}')">
                                        <i class="bi bi-trash text-danger"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center py-5">
                                <i class="bi bi-currency-exchange fs-1 text-muted d-block mb-2"></i>
                                <span class="text-muted">No transactions found for this period.</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{% include 'core_app/transaction/add_cash_modal.html' %}
{% include 'core_app/transaction/edit_cash_modal.html' %}

<div class="modal fade" id="deleteCashConfirmModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-body p-4 text-center">
                <i class="bi bi-exclamation-circle text-danger display-4 mb-3 d-block"></i>
                <h5 class="fw-bold">Delete Entry?</h5>
                <p class="text-muted small">Are you sure you want to remove this transaction?</p>
                <input type="hidden" id="delete_transID">
                <input type="hidden" id="delete_transVersion">
                <div class="d-flex justify-content-center gap-2 mt-4">
                    <button type="button" class="btn btn-light border px-4" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger px-4" id="btnConfirmDeleteCash"
                        onclick="confirmDeleteCash()">Delete</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const ajaxHeaders = {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
    };

    function formatHex(hex) {
        if (!hex || hex === 'None') return "";
        hex = hex.trim();
        return hex.startsWith('0x') ? hex : '0x' + hex;
    }

    window.initCashDataTable = function () {
        if ($.fn.DataTable.isDataTable('#cashGrid')) {
            $('#cashGrid').DataTable().destroy();
        }
        $('#cashGrid').DataTable({
            "stateSave": true,
            "paging": true,
            "pageLength": 15,
            "order": [[0, "desc"]],
            "language": {
                "search": "",
                "searchPlaceholder": "Search transactions...",
                "paginate": {
                    "next": '<i class="bi bi-chevron-right"></i>',
                    "previous": '<i class="bi bi-chevron-left"></i>'
                }
            },
            "columnDefs": [{ "orderable": false, "targets": 5 }]
        });
    }

    window.initSelect2Lookup = function (selector) {
        $(selector).each(function () {
            const $el = $(this);
            const lookupType = $el.data('type');
            $el.select2({
                theme: 'bootstrap-5',
                dropdownParent: $el.closest('.modal'),
                ajax: {
                    url: "{% url 'core_app:get_transaction_lookup_ajax' %}",
                    data: function (params) { return { q: params.term, type: lookupType }; },
                    processResults: function (data) { return { results: data.results }; }
                }
            });
        });
    }

    $(document).ready(function () {
        initCashDataTable();
        initSelect2Lookup('.select2-lookup');
    });

    function reloadCashTable() {
        const fromDate = $('#filter_from_date').val();
        const toDate = $('#filter_to_date').val();

        $('#cashGridContainer').css('opacity', '0.5');

        $.ajax({
            url: "{% url 'core_app:cash_book' %}",
            data: { from_date: fromDate, to_date: toDate },
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            success: function (html) {
                $('#main-content-area').html(html);
                initCashDataTable();
                initSelect2Lookup('.select2-lookup');
            },
            error: function () {
                $('#cashGridContainer').css('opacity', '1');
                alert("Failed to fetch data.");
            }
        });
    }

    function openAddCashModal() {
        $('#addCashForm')[0].reset();
        document.getElementById('add_cash_date').valueAsDate = new Date();
        $('#addCashModal').modal('show');
    }

    function openDeleteCashModal(id, version) {
        $('#delete_transID').val(id);
        $('#delete_transVersion').val(version);
        $('#deleteCashConfirmModal').modal('show');
    }

    function confirmDeleteCash() {
        const payload = {
            trans_id: parseInt($('#delete_transID').val()),
            version_hex: formatHex($('#delete_transVersion').val())
        };
        performCashAction("{% url 'core_app:delete_transaction' %}", payload, '#btnConfirmDeleteCash', '#deleteCashConfirmModal');
    }

    function performCashAction(url, payload, btnId, modalId) {
        const $btn = $(btnId);
        const originalText = $btn.html();
        $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span>');

        $.ajax({
            url: url,
            type: 'POST',
            data: JSON.stringify(payload),
            headers: ajaxHeaders,
            success: function (res) {
                if (res.status === 'success' || res.success) {
                    if (modalId) $(modalId).modal('hide');
                    reloadCashTable();
                } else {
                    alert("Error: " + (res.message || 'Action failed'));
                    $btn.prop('disabled', false).html(originalText);
                }
            },
            error: function () {
                alert("Server error.");
                $btn.prop('disabled', false).html(originalText);
            }
        });
    }
</script>
{% endblock %}