<div class="modal fade" id="addCashModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Add Cash Entry</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="addCashForm" onsubmit="event.preventDefault(); saveCashEntry();">
                <div class="modal-body p-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Transaction Date</label>
                            <input type="date" id="add_cash_date" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Voucher Type</label>
                            <select id="add_cash_vtcode" class="form-select select2-lookup" data-type="voucher_types"
                                required>
                                <option value="">Select Voucher Type</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Department</label>
                            <select id="add_cash_dept" class="form-select select2-lookup" data-type="departments"
                                required>
                                <option value="">Select Department</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Cost Center</label>
                            <select id="add_cash_cc" class="form-select select2-lookup" data-type="cost_centers"
                                required>
                                <option value="">Select Cost Center</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Account (Chart of Accounts)</label>
                            <select id="add_cash_account" class="form-select select2-lookup" data-type="accounts"
                                required>
                                <option value="">Select Account</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Reference Title</label>
                            <input type="text" id="add_cash_title" class="form-control"
                                placeholder="e.g. Utility Bill, Vendor Name">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Invoice/Ref #</label>
                            <input type="text" id="add_cash_invoice" class="form-control" placeholder="Optional">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Amount</label>
                            <div class="input-group">
                                <span class="input-group-text">Rs.</span>
                                <input type="number" step="0.01" id="add_cash_amount"
                                    class="form-control fw-bold text-primary" placeholder="0.00" required>
                            </div>
                        </div>

                        <div class="col-md-12">
                            <label class="form-label fw-semibold">Detailed Description</label>
                            <textarea id="add_cash_desc" class="form-control" rows="2"
                                placeholder="Explain the transaction..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-light border" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success px-4" id="btnSaveCash">
                        <i class="bi bi-save me-1"></i> Save Transaction
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        // Modal khulne par Select2 initialize karna aur Date set karna
        $('#addCashModal').on('shown.bs.modal', function () {
            if (!$('#add_cash_date').val()) {
                const today = new Date().toISOString().split('T')[0];
                $('#add_cash_date').val(today);
            }

            $('.select2-lookup').each(function () {
                const $this = $(this);
                const lookupType = $this.data('type');

                $this.select2({
                    dropdownParent: $('#addCashModal'),
                    width: '100%',
                    placeholder: 'Search...',
                    allowClear: true,
                    ajax: {
                        url: "{% url 'core_app:get_transaction_lookup_ajax' %}",
                        dataType: 'json',
                        delay: 250,
                        data: function (params) {
                            return {
                                q: params.term,
                                type: lookupType
                            };
                        },
                        processResults: function (data) {
                            return { results: data.results };
                        },
                        cache: true
                    }
                }).on('select2:open', function (e) {
                    // Click karte hi search box par focus set karne ke liye
                    document.querySelector('.select2-search__field').focus();
                });
            });
        });

        // Fix: Select2 search field focus issues on some browsers inside modals
        $(document).on('select2:open', () => {
            document.querySelector('.select2-search__field').focus();
        });
    });

    function saveCashEntry() {
        const formData = {
            vt_code: $('#add_cash_vtcode').val(),
            date: $('#add_cash_date').val(),
            ac_code: $('#add_cash_account').val(),
            dp_code: $('#add_cash_dept').val(),
            cc_code: $('#add_cash_cc').val(),
            title: $('#add_cash_title').val(),
            desc: $('#add_cash_desc').val(),
            amount: $('#add_cash_amount').val(),
            invoice: $('#add_cash_invoice').val()
        };

        if (!formData.vt_code || !formData.ac_code || !formData.dp_code || !formData.cc_code || !formData.amount) {
            alert("Please fill all required fields!");
            return;
        }

        $('#btnSaveCash').prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Saving...');

        $.ajax({
            url: "{% url 'core_app:add_transaction' %}",
            type: 'POST',
            data: JSON.stringify(formData),
            contentType: 'application/json',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            success: function (response) {
                if (response.status === 101) {
                    alert("Success: " + response.message + "\nVoucher No: " + response.voucher_no);
                    $('#addCashModal').modal('hide');
                    $('#addCashForm')[0].reset();
                    $('.select2-lookup').val(null).trigger('change');
                    if (typeof window.initCashDataTable === "function") window.initCashDataTable();
                } else if (response.status === 2002) {
                    alert("❌ Insufficient Funds: " + response.message);
                } else {
                    alert("⚠️ Error: " + response.message);
                }
            },
            error: function () {
                alert("Critical Error: Could not connect to server.");
            },
            complete: function () {
                $('#btnSaveCash').prop('disabled', false).html('<i class="bi bi-save me-1"></i> Save Transaction');
            }
        });
    }
</script>